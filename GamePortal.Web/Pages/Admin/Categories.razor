@page "/admin/categories"
@attribute [Authorize(Policy = "RequireAdmin")]
@using GamePortal.Core.Entities
@using GamePortal.Core.Interfaces
@inject ICategoryRepository CategoryRepository

<div class="container py-4 fade-in">
	<div class="admin-page-header">
		<h2><i class="bi bi-folder"></i> Categories Management</h2>
		<div class="text-muted">Organize your games into categories</div>
	</div>

	<!-- Create Category Form -->
	<div class="admin-card mb-4">
		<div class="admin-card-header">
			<i class="bi bi-plus-circle"></i> Create New Category
		</div>
		<div class="admin-card-body">
			<EditForm Model="newCategory" OnValidSubmit="CreateCategoryAsync">
				<DataAnnotationsValidator />
				<div class="row g-3">
					<div class="col-md-4">
						<label class="form-label required">
							<i class="bi bi-type"></i> Name
						</label>
						<InputText @bind-Value="newCategory.Name" class="form-control" placeholder="Category Name" />
					</div>
					<div class="col-md-4">
						<label class="form-label required">
							<i class="bi bi-link-45deg"></i> Slug
						</label>
						<InputText @bind-Value="newCategory.Slug" class="form-control" placeholder="category-slug" />
					</div>
					<div class="col-md-2">
						<label class="form-label">
							<i class="bi bi-sort-numeric-down"></i> Order
						</label>
						<InputNumber @bind-Value="newCategory.DisplayOrder" class="form-control" min="0" />
					</div>
					<div class="col-md-2 d-flex align-items-end">
						<button class="btn btn-primary w-100" type="submit">
							<i class="bi bi-plus-lg"></i> Add
						</button>
					</div>
				</div>
			</EditForm>
		</div>
	</div>

	<!-- Categories List -->
	@if (categories == null)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
	}
	else if (!categories.Any())
	{
		<div class="admin-card">
			<div class="admin-card-body text-center py-5">
				<i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted);"></i>
				<h5 class="mt-3">No categories found</h5>
				<p class="text-muted">Create your first category above!</p>
			</div>
		</div>
	}
	else
	{
		<div class="admin-card">
			<div class="admin-card-header">
				<i class="bi bi-list-ul"></i> All Categories
				<span class="badge bg-light text-dark ms-2">@categories.Count()</span>
			</div>
			<div class="table-wrapper">
				<table class="table mb-0">
					<thead>
						<tr>
							<th>Name</th>
							<th>Slug</th>
							<th>Order</th>
							<th>Status</th>
							<th style="width: 200px;">Actions</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var c in categories)
						{
							<tr>
								<td>
									@if (editCategory?.Id == c.Id)
									{
										<InputText @bind-Value="editCategory.Name" class="form-control form-control-sm" />
									}
									else 
									{ 
										<strong>@c.Name</strong>
									}
								</td>
								<td>
									@if (editCategory?.Id == c.Id)
									{
										<InputText @bind-Value="editCategory.Slug" class="form-control form-control-sm" />
									}
									else 
									{ 
										<code class="text-muted">@c.Slug</code>
									}
								</td>
								<td>
									@if (editCategory?.Id == c.Id)
									{
										<InputNumber @bind-Value="editCategory.DisplayOrder" class="form-control form-control-sm" min="0" />
									}
									else 
									{ 
										<span>@c.DisplayOrder</span>
									}
								</td>
								<td>
									@if (editCategory?.Id == c.Id)
									{
										<div class="form-check">
											<InputCheckbox @bind-Value="editCategory.IsActive" class="form-check-input" />
											<label class="form-check-label">Active</label>
										</div>
									}
									else 
									{ 
										@if (c.IsActive)
										{
											<span class="badge bg-success">Active</span>
										}
										else
										{
											<span class="badge bg-secondary">Inactive</span>
										}
									}
								</td>
								<td>
									@if (editCategory?.Id == c.Id)
									{
										<button class="btn btn-sm btn-success me-2" @onclick="SaveEditAsync">
											<i class="bi bi-check-lg"></i> Save
										</button>
										<button class="btn btn-sm btn-secondary" @onclick="CancelEdit">
											<i class="bi bi-x-lg"></i> Cancel
										</button>
									}
									else
									{
										<button class="btn btn-sm btn-outline-primary me-2" @onclick="() => BeginEdit(c)">
											<i class="bi bi-pencil"></i> Edit
										</button>
										<button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteAsync(c.Id)">
											<i class="bi bi-trash"></i> Delete
										</button>
									}
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		</div>
	}
</div>

@code {
	private List<Category>? categories;
	private Category newCategory = new() { IsActive = true, DisplayOrder = 1 };
	private Category? editCategory;

	protected override async Task OnInitializedAsync()
	{
		await ReloadAsync();
	}

	private async Task ReloadAsync()
	{
		var list = await CategoryRepository.GetAllAsync();
		categories = list.OrderBy(c => c.DisplayOrder).ToList();
		StateHasChanged();
	}

	private void BeginEdit(Category c)
	{
		editCategory = new Category
		{
			Id = c.Id,
			Name = c.Name,
			Slug = c.Slug,
			DisplayOrder = c.DisplayOrder,
			IsActive = c.IsActive
		};
	}

	private void CancelEdit()
	{
		editCategory = null;
	}

	private async Task CreateCategoryAsync()
	{
		newCategory.CreatedAt = DateTime.UtcNow;
		await CategoryRepository.AddAsync(newCategory);
		newCategory = new Category { IsActive = true, DisplayOrder = 1 };
		await ReloadAsync();
	}

	private async Task SaveEditAsync()
	{
		if (editCategory == null) return;
		editCategory.UpdatedAt = DateTime.UtcNow;
		CategoryRepository.Update(editCategory);
		editCategory = null;
		await ReloadAsync();
	}

	private async Task DeleteAsync(int id)
	{
		await CategoryRepository.DeleteAsync(id);
		await ReloadAsync();
	}
}
