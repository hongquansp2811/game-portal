@page "/admin/games"
@attribute [Authorize(Policy = "RequireAdmin")]
@using GamePortal.Core.DTOs
@using GamePortal.Core.Entities
@using GamePortal.Core.Interfaces
@using GamePortal.Core.Services
@inject IGameService GameService
@inject ICategoryRepository CategoryRepository

<div class="container py-4">
	<h2>Games Management</h2>

	<!-- Create/Edit Form -->
	<div class="card mb-4">
		<div class="card-body">
			<h5 class="card-title">@(editGameId.HasValue ? "Edit Game" : "Create New Game")</h5>
			<EditForm Model="currentGame" OnValidSubmit="@(editGameId.HasValue ? SaveGameAsync : CreateGameAsync)">
				<DataAnnotationsValidator />
				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label">Title *</label>
						<InputText @bind-Value="currentGame.Title" class="form-control" placeholder="Game Title" />
					</div>
					<div class="col-md-6">
						<label class="form-label">Slug *</label>
						<InputText @bind-Value="currentGame.Slug" class="form-control" placeholder="game-slug" />
					</div>
					<div class="col-md-6">
						<label class="form-label">Category *</label>
						<InputSelect @bind-Value="currentGame.CategoryId" class="form-select">
							<option value="0">-- Select Category --</option>
							@foreach (var cat in categories ?? new List<Category>())
							{
								<option value="@cat.Id">@cat.Name</option>
							}
						</InputSelect>
					</div>
					<div class="col-md-3">
						<label class="form-label">Rating (1-5)</label>
						<InputNumber @bind-Value="currentGame.Rating" class="form-control" min="1" max="5" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Game Type</label>
						<InputSelect @bind-Value="currentGame.GameType" class="form-select">
							<option value="Online">Online</option>
							<option value="Review">Review</option>
							<option value="Download">Download</option>
						</InputSelect>
					</div>
					<div class="col-12">
						<label class="form-label">Thumbnail URL *</label>
						<InputText @bind-Value="currentGame.ThumbnailUrl" class="form-control" placeholder="https://..." />
					</div>
					<div class="col-12">
						<label class="form-label">Game URL (for iframe) *</label>
						<InputText @bind-Value="currentGame.GameUrl" class="form-control" placeholder="https://... or relative path to game HTML" />
						<small class="form-text text-muted">URL c·ªßa game HTML ƒë·ªÉ embed trong iframe</small>
					</div>
					<div class="col-md-6">
						<label class="form-label">Platform</label>
						<InputText @bind-Value="currentGame.Platform" class="form-control" placeholder="Desktop, Mobile, Tablet" />
					</div>
					<div class="col-md-6">
						<label class="form-label">Description</label>
						<InputTextArea @bind-Value="currentGame.Description" class="form-control" rows="2" />
					</div>
					<div class="col-12">
						<label class="form-label">Full Description</label>
						<InputTextArea @bind-Value="currentGame.FullDescription" class="form-control" rows="4" />
					</div>
					<div class="col-md-6">
						<div class="form-check">
							<InputCheckbox @bind-Value="currentGame.IsHot" class="form-check-input" />
							<label class="form-check-label">Is Hot Game</label>
						</div>
					</div>
					<div class="col-md-6">
						<div class="form-check">
							<InputCheckbox @bind-Value="currentGame.IsFeatured" class="form-check-input" />
							<label class="form-check-label">Is Featured</label>
						</div>
					</div>
					<div class="col-12">
						<button class="btn btn-primary" type="submit">@(editGameId.HasValue ? "Update Game" : "Create Game")</button>
						@if (editGameId.HasValue)
						{
							<button class="btn btn-secondary" type="button" @onclick="CancelEdit">Cancel</button>
						}
					</div>
				</div>
			</EditForm>
		</div>
	</div>

	<!-- Games List -->
	@if (games == null)
	{
		<p>Loading...</p>
	}
	else if (!games.Any())
	{
		<div class="alert alert-info">No games found. Create your first game above!</div>
	}
	else
	{
		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">All Games (@games.Count())</h5>
				<input type="text" class="form-control form-control-sm" style="width: 200px;" 
					   placeholder="Search..." value="@searchTerm" @oninput="OnSearchInput" />
			</div>
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover mb-0">
						<thead class="table-light">
							<tr>
								<th style="width: 80px;">Thumb</th>
								<th>Title</th>
								<th>Category</th>
								<th>Type</th>
								<th>Rating</th>
								<th>Plays</th>
								<th>Status</th>
								<th style="width: 200px;">Actions</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var game in games)
							{
								<tr>
									<td>
										<img src="@game.ThumbnailUrl" alt="@game.Title" 
											 class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" />
									</td>
									<td>
										<strong>@game.Title</strong><br />
										<small class="text-muted">@game.Slug</small>
									</td>
									<td>@game.CategoryName</td>
									<td>@game.GameType</td>
									<td>
										@for (int i = 0; i < game.Rating; i++)
										{
											<span class="text-warning">‚òÖ</span>
										}
									</td>
									<td>@game.PlayCount</td>
									<td>
										@if (game.IsHot)
										{
											<span class="badge bg-danger">Hot</span>
										}
										@if (game.IsFeatured)
										{
											<span class="badge bg-warning">Featured</span>
										}
									</td>
									<td>
										<a href="/games/@game.Slug" target="_blank" class="btn btn-sm btn-outline-info me-1" title="View">
											üëÅÔ∏è
										</a>
										<button class="btn btn-sm btn-outline-primary me-1" @onclick="() => BeginEdit(game.Id)" title="Edit">
											‚úèÔ∏è
										</button>
										<button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteGameAsync(game.Id)" title="Delete">
											üóëÔ∏è
										</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	}
</div>

@code {
	private List<GameDTO>? games;
	private List<Category>? categories;
	private CreateGameDTO currentGame = new();
	private int? editGameId = null;
	private string searchTerm = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		categories = (await CategoryRepository.GetAllAsync()).Where(c => c.IsActive).OrderBy(c => c.DisplayOrder).ToList();
		games = (await GameService.GetAllGamesAsync(0, 100)).ToList();
		StateHasChanged();
	}

	private async Task CreateGameAsync()
	{
		try
		{
			if (currentGame.CategoryId == 0) return;
			await GameService.CreateGameAsync(currentGame);
			currentGame = new CreateGameDTO();
			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error creating game: {ex.Message}");
		}
	}

	private async Task BeginEdit(int gameId)
	{
		var gameDto = await GameService.GetGameByIdAsync(gameId);
		if (gameDto != null)
		{
			// Get full details including FullDescription
			var game = games?.FirstOrDefault(g => g.Id == gameId);
			var gameDetail = await GameService.GetGameBySlugAsync(gameDto.Slug);
			
			editGameId = gameId;
			currentGame = new CreateGameDTO
			{
				Title = gameDto.Title,
				Slug = gameDto.Slug,
				ThumbnailUrl = gameDto.ThumbnailUrl,
				Description = gameDto.Description,
				FullDescription = gameDetail?.FullDescription,
				Rating = gameDto.Rating,
				GameType = gameDto.GameType,
				Platform = gameDto.Platform,
				GameUrl = gameDto.GameUrl,
				IsHot = gameDto.IsHot,
				IsFeatured = gameDto.IsFeatured,
				CategoryId = categories?.FirstOrDefault(c => c.Name == gameDto.CategoryName)?.Id ?? 0
			};
		}
	}

	private void CancelEdit()
	{
		editGameId = null;
		currentGame = new CreateGameDTO();
	}

	private async Task SaveGameAsync()
	{
		try
		{
			if (!editGameId.HasValue || currentGame.CategoryId == 0) return;
			var updateDto = new UpdateGameDTO
			{
				Title = currentGame.Title,
				Slug = currentGame.Slug,
				ThumbnailUrl = currentGame.ThumbnailUrl,
				Description = currentGame.Description,
				FullDescription = currentGame.FullDescription,
				Rating = currentGame.Rating,
				GameType = currentGame.GameType,
				Platform = currentGame.Platform,
				GameUrl = currentGame.GameUrl,
				IsHot = currentGame.IsHot,
				IsFeatured = currentGame.IsFeatured,
				CategoryId = currentGame.CategoryId
			};
			await GameService.UpdateGameAsync(editGameId.Value, updateDto);
			CancelEdit();
			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error updating game: {ex.Message}");
		}
	}

	private async Task DeleteGameAsync(int gameId)
	{
		try
		{
			await GameService.DeleteGameAsync(gameId);
			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error deleting game: {ex.Message}");
		}
	}

	private async Task OnSearchInput(ChangeEventArgs e)
	{
		searchTerm = e.Value?.ToString() ?? string.Empty;
		if (string.IsNullOrWhiteSpace(searchTerm))
		{
			await LoadDataAsync();
		}
		else
		{
			games = (await GameService.SearchGamesAsync(searchTerm)).ToList();
			StateHasChanged();
		}
	}
}
