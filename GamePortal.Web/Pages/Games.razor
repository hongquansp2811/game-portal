@page "/games"
@using GamePortal.Core.DTOs
@using GamePortal.Core.Entities
@using GamePortal.Core.Interfaces
@using GamePortal.Core.Services
@inject IGameService GameService
@inject ICategoryRepository CategoryRepository
@inject NavigationManager Navigation

<div class="container-fluid">
	<!-- Top Banners -->
	<div class="container mb-4">
		<BannerDisplay Position="@BannerPosition.Top" CssClass="top-banner" />
	</div>
</div>

<div class="container py-5">
	<h1 class="mb-3" style="font-weight: 700; font-size: 2.5rem; color: var(--text-primary);">
		<i class="bi bi-controller"></i> All Games
	</h1>
	<p class="text-muted mb-4" style="font-size: 1.125rem;">Browse all available games. Click on a game to play!</p>

	<!-- Search and Filter -->
	<div class="card mb-5" style="background: var(--bg-card); border-color: var(--border-color);">
		<div class="card-body" style="padding: 2rem;">
			<div class="row g-3">
				<div class="col-md-6">
					<label class="form-label" style="color: var(--text-primary); font-weight: 600;">
						<i class="bi bi-search"></i> Search Games
					</label>
					<div class="input-group">
						<input type="text" class="form-control" placeholder="Search by name..." 
							   value="@searchTerm" @oninput="OnSearchInput" 
							   style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" />
						<button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch"
								style="border-color: var(--border-color); color: var(--text-secondary);">
							<i class="bi bi-x-lg"></i> Clear
						</button>
					</div>
				</div>
				<div class="col-md-6">
					<label class="form-label" style="color: var(--text-primary); font-weight: 600;">
						<i class="bi bi-funnel"></i> Filter by Category
					</label>
					<select class="form-select" @onchange="OnCategoryFilterChanged"
							style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
						<option value="0">All Categories</option>
						@foreach (var cat in categories ?? new List<GamePortal.Core.Entities.Category>())
						{
							<option value="@cat.Id" selected="@(selectedCategoryId == cat.Id)">@cat.Name</option>
						}
					</select>
				</div>
			</div>
		</div>
	</div>

	<!-- Games Grid -->
	@if (games == null)
	{
		<div class="text-center py-5">
			<div class="spinner-border" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
	}
	else if (!games.Any())
	{
		<div class="alert alert-info">
			<h4>No games found</h4>
			<p>@(string.IsNullOrEmpty(searchTerm) && selectedCategoryId == 0 
				? "Please add seed data." 
				: "Try adjusting your search or filter.")</p>
		</div>
	}
	else
	{
		<div class="mb-4">
			<strong style="color: var(--text-primary); font-size: 1.125rem;">
				Found <span style="color: var(--accent-purple);">@games.Count()</span> game(s)
			</strong>
		</div>
		<div class="row g-4">
			@foreach (var game in games)
			{
				<div class="col-md-3">
					<div class="card h-100 game-card" style="cursor: pointer; background: var(--bg-card); border-color: var(--border-color);" @onclick="() => NavigateToGame(game.Slug)">
						<img src="@game.ThumbnailUrl" class="card-img-top" alt="@game.Title" style="height: 200px; object-fit: cover;">
						<div class="card-body">
							<h5 class="card-title" style="color: var(--text-primary); font-weight: 600;">@game.Title</h5>
							<p class="text-muted mb-2"><small>@game.CategoryName</small></p>
							<div class="d-flex justify-content-between align-items-center mb-2">
								<div>
									@for (int i = 0; i < game.Rating; i++)
									{
										<span class="text-warning" style="color: #fbbf24;">‚òÖ</span>
									}
								</div>
								<small class="text-muted">@game.PlayCount plays</small>
							</div>
						</div>
						@if (game.IsHot || game.IsFeatured)
						{
							<div class="card-footer" style="background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
								@if (game.IsHot)
								{
									<span class="badge" style="background: var(--accent-red); margin-right: 0.5rem;">üî• Hot</span>
								}
								@if (game.IsFeatured)
								{
									<span class="badge" style="background: #f59e0b;">‚≠ê Featured</span>
								}
							</div>
						}
					</div>
				</div>
			}
		</div>
	}
</div>

@code {
	private IEnumerable<GameDTO>? games;
	private List<GamePortal.Core.Entities.Category>? categories;
	private string searchTerm = string.Empty;
	private int selectedCategoryId = 0;

	protected override async Task OnInitializedAsync()
	{
		await LoadCategoriesAsync();
		await LoadGamesAsync();
	}

	private async Task LoadCategoriesAsync()
	{
		var allCategories = await CategoryRepository.GetAllAsync();
		categories = allCategories.Where(c => c.IsActive).OrderBy(c => c.DisplayOrder).ToList();
	}

	private async Task LoadGamesAsync()
	{
		var categoryName = categories?.FirstOrDefault(c => c.Id == selectedCategoryId)?.Name;

		if (!string.IsNullOrWhiteSpace(searchTerm))
		{
			var searchedGames = await GameService.SearchGamesAsync(searchTerm);
			// Filter by category if selected
			if (selectedCategoryId > 0 && !string.IsNullOrEmpty(categoryName))
			{
				games = searchedGames.Where(g => g.CategoryName == categoryName).ToList();
			}
			else
			{
				games = searchedGames.ToList();
			}
		}
		else if (selectedCategoryId > 0)
		{
			games = (await GameService.GetGamesByCategoryAsync(selectedCategoryId, 0, 100)).ToList();
		}
		else
		{
			games = (await GameService.GetLatestGamesAsync(100)).ToList();
		}
	}

	private async Task OnSearchInput(ChangeEventArgs e)
	{
		searchTerm = e.Value?.ToString() ?? string.Empty;
		await LoadGamesAsync();
	}

	private async Task ClearSearch()
	{
		searchTerm = string.Empty;
		await LoadGamesAsync();
	}

	private async Task OnCategoryFilterChanged(ChangeEventArgs e)
	{
		if (int.TryParse(e.Value?.ToString(), out int categoryId))
		{
			selectedCategoryId = categoryId;
			await LoadGamesAsync();
		}
	}

	private void NavigateToGame(string slug)
	{
		Navigation.NavigateTo($"/games/{slug}");
	}
}
