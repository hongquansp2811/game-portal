@page "/games/{Slug}"
@using GamePortal.Core.DTOs
@using GamePortal.Core.Services
@inject IGameService GameService
@inject NavigationManager Navigation

<div class="container py-5">
	@if (game == null)
	{
		<div class="alert alert-warning" style="background: rgba(245, 158, 11, 0.15); border-left: 4px solid #f59e0b; color: #f59e0b; border-radius: var(--radius-md);">
			<h4>Game not found</h4>
			<p>The game you're looking for doesn't exist.</p>
			<a href="/games" class="btn btn-primary">Back to Games</a>
		</div>
	}
	else
	{
		<!-- Game Header -->
		<div class="row mb-5">
			<div class="col-md-4">
				<img src="@game.ThumbnailUrl" alt="@game.Title" class="img-fluid rounded" style="box-shadow: var(--shadow-lg); border: 2px solid var(--border-color);" />
			</div>
			<div class="col-md-8">
				<h1 style="font-weight: 700; font-size: 2.5rem; color: var(--text-primary); margin-bottom: 1rem;">@game.Title</h1>
				<p class="text-muted mb-3">
					Category: <a href="/games/category/@game.CategorySlug" style="color: var(--accent-cyan);">@game.CategoryName</a>
					@if (game.IsHot)
					{
						<span class="badge ms-2" style="background: var(--accent-red);">üî• Hot</span>
					}
					@if (game.IsFeatured)
					{
						<span class="badge ms-2" style="background: #f59e0b;">‚≠ê Featured</span>
					}
				</p>
				<div class="mb-4">
					@for (int i = 0; i < game.Rating; i++)
					{
						<span class="text-warning fs-4" style="color: #fbbf24;">‚òÖ</span>
					}
					<span class="ms-2" style="color: var(--text-secondary);">(@game.Rating / 5)</span>
					<span class="ms-3" style="color: var(--text-secondary);">
						<strong style="color: var(--accent-purple);">@game.PlayCount</strong> plays
					</span>
				</div>
				@if (!string.IsNullOrEmpty(game.Description))
				{
					<p class="lead" style="color: var(--text-secondary); font-size: 1.125rem; line-height: 1.7;">@game.Description</p>
				}
				@if (!string.IsNullOrEmpty(game.Platform))
				{
					<p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Platform:</strong> @game.Platform</p>
				}
				<p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Type:</strong> @game.GameType</p>
			</div>
		</div>

		<!-- Full Description -->
		@if (!string.IsNullOrEmpty(game.FullDescription))
		{
			<div class="card mb-5" style="background: var(--bg-card); border-color: var(--border-color);">
				<div class="card-body" style="padding: 2rem;">
					<h5 class="card-title" style="color: var(--text-primary); font-weight: 600; margin-bottom: 1rem;">
						<i class="bi bi-info-circle"></i> About This Game
					</h5>
					<p class="card-text" style="color: var(--text-secondary); line-height: 1.7;">@game.FullDescription</p>
				</div>
			</div>
		}

		<!-- Game Gallery -->
		@if (game.GalleryImages != null && game.GalleryImages.Any())
		{
			<div class="card mb-5" style="background: var(--bg-card); border-color: var(--border-color);">
				<div class="card-body" style="padding: 2rem;">
					<h5 class="card-title" style="color: var(--text-primary); font-weight: 600; margin-bottom: 1.5rem;">
						<i class="bi bi-images"></i> Screenshots
					</h5>
					<div class="row g-4">
						@foreach (var img in game.GalleryImages)
						{
							<div class="col-md-3">
								<img src="@img" alt="Screenshot" class="img-fluid rounded" style="cursor: pointer; border: 2px solid var(--border-color); transition: all 0.3s ease;" 
									 onclick="window.open('@img', '_blank')" 
									 onmouseover="this.style.borderColor='var(--accent-purple)'; this.style.transform='scale(1.05)';"
									 onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='scale(1)';" />
							</div>
						}
					</div>
				</div>
			</div>
		}

		<!-- Game Play Area -->
		<div class="card mb-5" style="background: var(--bg-card); border-color: var(--border-color); overflow: hidden;">
			<div class="card-header" style="background: var(--gradient-primary); color: white; padding: 1.5rem 2rem; border: none;">
				<h4 class="mb-0" style="font-weight: 600;">
					<i class="bi bi-play-circle-fill"></i> Play Game
				</h4>
			</div>
			<div class="card-body p-0">
				@if (string.IsNullOrEmpty(game.GameUrl))
				{
					<div class="alert alert-warning m-4" style="background: rgba(245, 158, 11, 0.15); border-left: 4px solid #f59e0b; color: #f59e0b;">
						<p>Game URL is not configured. Please contact administrator.</p>
					</div>
				}
				else
				{
					<div style="position: relative; width: 100%; padding-bottom: 75%; background: #000;">
						<iframe 
							src="@game.GameUrl" 
							style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
							allowfullscreen
							allow="autoplay; fullscreen; microphone; camera; gamepad; payment; geolocation"
							sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-presentation"
							title="@game.Title">
						</iframe>
					</div>
				}
			</div>
		</div>

		<!-- Related Games -->
		<div class="card" style="background: var(--bg-card); border-color: var(--border-color);">
			<div class="card-body" style="padding: 2rem; text-align: center;">
				<h5 class="card-title" style="color: var(--text-primary); font-weight: 600; margin-bottom: 1.5rem;">
					<i class="bi bi-grid"></i> More Games
				</h5>
				<div class="row">
					<div class="col-12">
						<a href="/games" class="btn btn-primary me-2">Browse All Games</a>
						<a href="/" class="btn btn-secondary">Back to Home</a>
					</div>
				</div>
			</div>
		</div>
	}
</div>

@code {
	[Parameter]
	public string Slug { get; set; } = string.Empty;

	private GameDetailDTO? game;

	protected override async Task OnInitializedAsync()
	{
		if (!string.IsNullOrEmpty(Slug))
		{
			game = await GameService.GetGameBySlugAsync(Slug);
			if (game != null)
			{
				// Increment play count when user views the game
				await GameService.IncrementPlayCountAsync(game.Id);
			}
		}
	}
}
